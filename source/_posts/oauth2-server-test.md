---
title: oauth2.0认证服务器搭建流程笔记
date: 2016-10-07 00:43:36
categories: 
- 系统
tags:
- server
---

OAuth认证流程有什么用，想必使用过第三方账号登录的大家也都有所了解过。某些第三方应用在用户使用合作账号登录时会获取资料。比如多说评论框，在使用qq账号登录时，获取了用户的qq头像以及昵称等信息。传统的做法要使多说评论框获取这些信息，需要将用户的qq账号和密码告诉多说，这样做有几个严重的缺点。

- 多说会保存用户的账号密码，为了给用户提供后续服务，那么当多说被破解时，将导致用户的账号信息泄露
- 多说将拥有用户账号所有者的权限，可以任意获取以及修改用户信息
- 用户收回权限，必须改密，改密后多说将失去用户资源的所有访问及修改权限

而OAuth认证就是为了解决上述问题而诞生的。

<!-- more -->
先来一张流程图吧:
<pre>
     +----------+
     | Resource |
     |   Owner  |
     |  用  户  |
     +----------+
          ^
          |                
         (B)               跳转到认证服务器的授权页
     +----|-----+          Client Identifier      +---------------+
     |         -+----(A)-- & Redirection URI ----&gt;|               |
     |          |                                 |               |
     |  User-   |          用户同意授权            | Authorization |
     |  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |
     |          |                                 |               |
     |  浏览器   |          返回授权码              |  认证服务器    |
     |         -+----(C)-- Authorization Code ---&lt;|               |
     +-|----|---+                                 +---------------+
       |    |                                         ^      v
      (A)  (C)                                        |      |
       |    |                                         |      |
       ^    v                                         |      |
     +---------+                申请令牌               |      |
     |         |&gt;---(D)-- Authorization Code ---------'      |
     |  Client |          & Client Identifier                |
     |         |          & Client Secret                    |
     |  第三方 |           & Redirection URI                  |
     |  应用   |                返回令牌                       |
     |         |&lt;---(E)----- Access Token -------------------'
     +-|----|--+       (w/ Optional Refresh Token)
       |    |                    请求资源             +-----------+
       |    |----------(F)----- Access Token --------&gt;|           |
       |                        & Client Identifier   | Resource  |
       |                         返回资源              | Server    |
       |---------------(G)----- Protected Resource---&lt;|   资源    |
                                                      |  服务器   |
                                                      +-----------+
</pre>

流程解释: 

- (A) 用户通过浏览器访问第三方应用，第三方应用将浏览器页面重定向到认证服务器的授权页面，并附上第三方应用id和约定好的重定向uri参数
- (B) 用户选择是否同意授权
- (C) 如果用户同意授权，认证服务器将浏览器导向之前约定好的重定向uri(返回第三方应用)，并附上用来获取令牌的授权码
- (D) 第三方应用收到授权码后，将授权码，第三方应用的认证id，第三方应用认证密码以及约定好的重定向uri作为参数，继续向认证服务器请求获取令牌
- (E) 认认证服务器核对各个参数无误后，同意向第三方应用发放令牌以及可选的更新令牌
- (F) 在成功获取到令牌后，调用Api时通过附加令牌和第三方应用id来请求资源
- (G) 资源服务器核对各个参数无误后，向第三方应用返回资源结果

注: 上述所有的授权码以及令牌都是具有时效性的，超时后需重新申请！
    认证服务器和资源服务器可以是同一台服务器。

未完待续...

### 参考文献
[rfc6749](https://tools.ietf.org/html/rfc6749)
[理解OAuth 2.0](http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)
[Node.js实战第二季](https://book.douban.com/subject/26642320/)